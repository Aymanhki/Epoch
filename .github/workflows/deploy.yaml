name: Deploy to Google Cloud VM

on:
  push:
    branches:
      - main

jobs:
  test-new-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install SSH Client and sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass
          sudo apt-get install -y python3-pip


      - name: SSH into Google Cloud VM for testing
        run: |
          set -e 
          sshpass -p ${{ secrets.TESTER_SSH_PASSWORD }} ssh -o StrictHostKeyChecking=no ${{ secrets.TESTER_SSH_USERNAME }} << EOF
            echo "Current directory path: $(pwd)"
            cd 
            rm -rf Epoch
            sudo fuser -k -n tcp 443
            sudo fuser -k -n tcp 8080
            sudo fuser -k -n tcp 80
            sudo fuser -k -n tcp 8000
            docker stop \$(docker ps -q)
            docker rm \$(docker ps -aq)
            docker rmi \$(docker images -q)
            git clone https://github.com/Aymanhki/Epoch.git 
            cd
            cd Epoch/
            if ! pytest -s --cov=epoch_backend -rA -vv --color=yes ./epoch_backend/tests/webserver_tests.py --full-trace; then
              echo "Test(s) failed. Exiting with status 1."
              exit 1
            fi
            if ! docker build -t epoch_backend ./epoch_backend/; then
              echo "Docker build failed. Exiting with status 1."
              exit 1
            fi
            if ! docker run -d -p 8080:8080 epoch_backend; then
              echo "Docker run failed. Exiting with status 1."
              exit 1
            fi
            if ! docker build -t epoch_frontend ./epoch_frontend; then
              echo "Docker build failed. Exiting with status 1."
              exit 1
            fi
            if ! docker run -d -p 80:80 -p 443:443 epoch_frontend; then
              echo "Docker run failed. Exiting with status 1."
              exit 1
            fi
            sudo fuser -k -n tcp 443
            sudo fuser -k -n tcp 8080
            sudo fuser -k -n tcp 80
            sudo fuser -k -n tcp 8000
            docker stop \$(docker ps -q)
            docker rm \$(docker ps -aq)
            docker rmi \$(docker images -q)
            exit 0
          EOF

  clean-old-build:
    needs: test-new-build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install SSH Client and sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass

      - name: SSH into Google Cloud VM for cleanup
        run: |
          sshpass -p ${{ secrets.SSH_PASSWORD }} ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }} << EOF
            echo "Current directory path: $(pwd)"
            cd 
            rm -rf Epoch
            sudo fuser -k -n tcp 443
            sudo fuser -k -n tcp 8080
            sudo fuser -k -n tcp 80
            sudo fuser -k -n tcp 8000
            docker stop \$(docker ps -q)
            docker rm \$(docker ps -aq)
            docker rmi \$(docker images -q)
            git clone https://github.com/Aymanhki/Epoch.git 
            cd
            cd Epoch/epoch_backend/assets/
            cp /etc/letsencrypt/live/aymanhkias.com/fullchain.pem ./
            cp /etc/letsencrypt/live/aymanhkias.com/privkey.pem ./
            cd
            cd Epoch/epoch_frontend/
            cp /etc/letsencrypt/live/aymanhkias.com/fullchain.pem ./
            cp /etc/letsencrypt/live/aymanhkias.com/privkey.pem ./
            cd
            exit
          EOF

  deploy-new-build:
    needs: clean-old-build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install SSH Client and sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass

      - name: Deploying Backend (Build and Run Backend Docker Container)
        run: |
          sshpass -p ${{ secrets.SSH_PASSWORD }} ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }} << EOF
            echo "Current directory path: $(pwd)"
            cd
            cd Epoch/epoch_backend/
            docker build -t epoch_backend ./
            docker run -d -p 8080:8080 epoch_backend
            exit
          EOF
        if: success()

      - name: Deploying Frontend (Build and Run Frontend Docker Container)
        run: |
          sshpass -p ${{ secrets.SSH_PASSWORD }} ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }} << EOF
            echo "Current directory path: $(pwd)"
            cd
            cd Epoch/epoch_frontend/
            docker build -t epoch_frontend ./
            docker run -d -p 80:80 -p 443:443 epoch_frontend
            exit
          EOF
        if: success()
